# 去除冗余功能的精准修复计划

感谢您提供的截图和上下文！截图显示 Chat Panel 的菜单也是通过 `cdk-overlay-container` 弹出的，这意味着我们不能仅靠 Overlay 本身来区分。我们必须**回溯触发源**。

## 1. NotebookLM 修复 (`content_notebooklm.js`)

### A. 屏蔽 Chat Panel 菜单 (精准方案)
*   **原理**: 菜单弹出时，触发它的按钮通常会有 `aria-expanded="true"` 属性。我们需要检查这个按钮**是否在 Chat Panel 区域内**。
*   **逻辑**: 在 `injectMenuItem` 中：
    1.  查找触发按钮：`const triggerBtn = document.querySelector('button[aria-expanded="true"]');`
    2.  **黑名单检查**: 如果 `triggerBtn` 位于 Chat Panel 容器内（通常是 `.chat-window`, `main` 右侧区域，或者不包含在 `.source-sidebar` 中），则**不注入**。
    3.  **白名单检查 (推荐)**: 仅当 `triggerBtn` 位于左侧资源列表容器（需要确认容器类名，通常是包含 "Source" 字样的区域，或者我们可以检查它是否在 `.single-source-container` 或 `.row` 内）时，才注入。
*   **代码调整**:
    ```javascript
    // 在 injectMenuItem 开头添加
    const triggerBtn = document.querySelector('button[aria-expanded="true"]');
    if (triggerBtn) {
        // 如果按钮不在 source row 里，或者在 chat panel 里，就退出
        if (!triggerBtn.closest('.row') && !triggerBtn.closest('.single-source-container')) {
             console.log("NotebookLM Extension: Ignoring menu injection (not in source row)");
             return;
        }
    }
    ```

### B. 屏蔽 Homepage 菜单
*   **逻辑**: `if (window.location.pathname === '/' || !window.location.pathname.includes('/notebook/')) return;`

## 2. Gemini 修复 (`content_gemini.js`)

### A. 屏蔽 Gems 菜单
*   **逻辑**: 在 `setupGlobalClickListener` 中，如果点击的按钮位于 `gems-list-container` 内，或者其关联的链接包含 `/gem/`，则不设置 `state.currentMenuContext`。这样后续菜单弹出时，因为没有 Context，我们可以在 `injectMenuItem` 中直接返回。

## 3. 执行步骤 (不含收尾)
1.  **修改 `content_notebooklm.js`**: 实施 Homepage 和 Chat Panel 的屏蔽逻辑。
2.  **修改 `content_gemini.js`**: 实施 Gems 的屏蔽逻辑。
3.  **验证**: 确认修改后的逻辑能正确拦截目标菜单，同时保留正常的 Source List 和 Chat List 菜单。

我将立即开始修改代码。
